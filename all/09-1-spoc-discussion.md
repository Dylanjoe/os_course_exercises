# lec 21: 文件系统 spoc 思考题
- 有"spoc"标记的题是要求拿清华学分的同学在实体课上完成的，对于学堂在线的选课同学是可选题目。
## 视频相关思考题
### 21.1 文件系统和文件 

1. 文件系统的功能是什么？

 >  负责数据持久保存，功能是数据存储和访问

 >  具体功能：文件分配、文件管理、数据可靠和安全

2. 什么是文件、文件属性、文件头？

 > 文件：文件系统中具有符号名，由字节序列构成的数据项集合。

 > 文件属性：文件系统中保存的与文件相关的属性信息，如文件名、文件访问权限、文件访问时间等。

 > 文件头：文件系统元数据中的文件信息，如文件存储位置等。

3. 文件系统和内存管理在功能和实现算法上有什么异同？

 > 相同：数据保存、分配、释放
 
 > 不同：数据保存的持久性、管理的数据量大小、数据可靠性、数据访问安全性、服务对象、服务接口

### 21.2 文件描述符

1. 打开文件时，文件系统要维护哪些信息？

 > 打开文件的状态和信息：文件指针、打开文件计数、访问权限、文件的磁盘存储位置和文件数据缓存

2. 文件系统的基本数据访问单位是什么？这对文件系统有什么影响？

 > 文件是文件系统的基本数据访问单位；

 > 文件访问时操作系统维护的文件描述符信息是对应文件的；

3. 文件的索引访问有什么特点？如何优化索引访问的速度？

 > 文件的索引访问是，先访问索引，以确定要访问的文件位置；再读写文件内容。

 > 文件索引的访问频率远大于文件内容读写。

 > 优化方法：文件的索引信息和文件内容分别保存在不同的数据块。

4. 文件访问方式有哪几种？文件访问方式对文件系统的设计有什么影响？

 > 文件访问方式：顺序访问、随机访问、索引访问

 > 文件访问特征对文件系统的要求会影响文件系统存储组织和操作系统中文件系统模块的实现方法选择；

### 21.3 目录、文件别名和文件系统种类

1. 什么是目录？

 >  由文件索引项组成的特殊文件。

2. 目录的组织结构是什么样的？

 > 树结构（分层文件系统）、有向图

3. 目录操作有哪些种类？

 > 目录读操作：搜索、遍历、列目录

 > 目录写操作：创建、删除、重命名

4. 什么是文件别名？软链接和硬链接有什么区别？

 > 文件别名：两个或多个文件关联同一个文件；

 > 硬链接：多个文件目录项指向一个文件；

 > 软链接：文件内容是指向文件的路径；

 > 硬链接和软链接的文件删除操作的语义是不同的；

5. 路径遍历的流程是什么样的？如何优化路径遍历？

 > 路径遍历：从根目录开始，读取路径包含的每一级目录，查找下一级目录项和存储位置，直到最后一级；

 > 路径遍历的优化：目录缓存和当前目录；

6. 什么是文件系统挂载？

 > 文件系统挂载（mount）：把一个文件卷（文件系统）映射到系统根文件系统的某个挂载目录节点；

7. 为什么会存在大量的文件系统类型？

 > 数据类型：16位、32位、64位、128位文件系统

 > 存储介质类型：磁盘、光盘等

 > 访问安全要求类型：单用户文件系统、多用户文件系统

 > 数据可靠性要求类型：日志文件系统

 > 应用场景类型：网络、本地
 
8. 在UFS文件系统中允许创建指向父辈目录（即从根目录到当前目录的路径上的目录）的软链接或硬链接，从而在目录树中形成循环结构。这会影响到目录查找和遍历相关的操作。请尝试给出一种在允许循环目录结构的文件系统中遍历操作的影响的解决方法，并有Linux或ucore上进行实现。

 > 一种可能的解法：在遍历的过程中检查重复的目录，并终止该分支的遍历操作。

### 21.4 虚拟文件系统 

1. 虚拟文件系统的功能是什么？

 > 对上接口：统一上层应用的文件访问和控制接口

 > 对下接口：实现对多种类型文件的访问和控制交互；

 > 高效访问实现：打开文件信息的管理、高效的路径遍历实现

2. 文件卷控制块、文件控制块和目录项的相互关系是什么？

 > 文件卷控制块：文件系统描述信息，如数据块大小、存储格式、空余块数目等；每个文件卷对应一个；挂载时读入内存；

 > 文件控制块：文件的描述信息，如文件数据的存储位置和顺序等；每个文件对应一个；打开文件时读入内存；

 > 目录项：每个目录由若干目录项组成，所有目录项共同形成文件系统的树状结构；每个目录项对应一个文件或目录；路径遍历时读入内存；

3. 可以把文件控制块放到目录项中吗？这样做有什么优缺点？

 > 可以。

 > 优点：实现简单；

 > 缺点：搜索时的数据读入量比较大；

### 21.5 文件缓存和打开文件

1. 虚拟存储和文件缓存有什么区别和联系？

 > 联系：虚拟存储和文件缓存同时用到物理内存，占用的内存空间是相互影响的

 > 区别：虚拟存储是用外存来模拟内存、文件缓存是用内存来模拟外存
 
2. 文件的数据块缓存和页缓存有什么区别和联系？
 
 > 联系：物理内存空间的分配

 > 区别：数据缓存是把页面访问映射到数据块访问、页缓存是把文件访问映射到页面访问
 
3. 为什么要同时维护进程的打开文件表和操作系统的打开文件表？这两个打开文件表有什么区别和联系？为什么没有线程的打开文件表？

 > 系统打开文件表：目录项和文件控制块信息的缓存、引用计数等

 > 进程打开文件表：进程的打开文件的状态信息，如文件指针、文件访问权限等

 > 联系：针对打开文件在内存中维护的数据缓存和文件状态信息

 > 区别：进程打开文件表维护本进程特有的打开文件状态信息，系统打开文件表维护所有进程共用的打开文件信息；

 > 相同进程中的各线程共享进程的打开文件信息，并没有需求针对线程维护打开文件状态信息；
 
### 21.6 文件分配

1. 文件分配的三种方式是如何组织文件数据块的？各有什么特征（存储、文件读写、可靠性）？

 > 连续分配：文件数据块的存储是连续的；特征：存储位置必须在大于所需空间的空闲空间；读取性能比较好，文件增长开销比较大；

 > 链式分配：用数据块的链表来存储文件数据块；特征：文件修改比较方便，随机文件读取开销大，可靠性比较差；

 > 索引分配：用索引数据块来保存文件数据块的存储位置和顺序；特征：小文件存储开销大；文件读写性能较好；

2. UFS多级索引分配是如何组织文件数据块的位置信息的？

 > 多种文件分配方式综合使用：直接索引、一级索引、二级索引、三级索引都可能使用；

### 21.7 空闲空间管理和冗余磁盘阵列RAID

1. 硬盘空闲空间组织和文件分配有什么异同？
 
 > 空闲空间组织不需要管顺序，而文件分配需要维护占用数据块的顺序

 > 都需要维护管理有数据块有哪些

2. RAID-0、1、4和5分别是如何组织磁盘数据块的？各有什么特征？

 > 条带化：在多个独立硬盘上存储数据块，通过并行读写提高I/O性能；

 > 校验和：按位做校验、按块做校验

 > 实现方式：硬件、软件

 > RAID-0：条带化

 > RAID-1：镜像

 > RAID-4：带校验的磁盘条带化

 > RAID-5：带分布式校验的磁盘条带化

## 小组思考题
 1. (spoc)完成Simple File System的功能，支持应用程序的一般文件操作。具体帮助和要求信息请看[sfs-homework](https://github.com/chyyuu/ucore_lab/blob/master/related_info/lab8/sfs-homework.md)


 2. (spoc)FAT、UFS、YAFFS、NTFS这几种文件系统中选一种，分析它的文件卷结构、目录结构、文件分配方式，以及它的变种。
  wikipedia上的文件系统列表参考
  - http://en.wikipedia.org/wiki/List_of_file_systems
  - http://en.wikipedia.org/wiki/File_system
  - http://en.wikipedia.org/wiki/List_of_file_systems

  往届同学的参考回答：
  
  - [FAT文件系统分析](https://piazza.com/class/i5j09fnsl7k5x0?cid=416)
  - [NTFS文件系统分析](https://piazza.com/class/i5j09fnsl7k5x0?cid=417)
  - [UFS文件系统分析](https://piazza.com/class/i5j09fnsl7k5x0?cid=418)
  - [ZFS文件系统分析](https://piazza.com/class/i5j09fnsl7k5x0?cid=861)
  - [YAFFS文件系统分析](https://piazza.com/class/i5j09fnsl7k5x0?cid=861)

## 问答题

### 文件系统概念

#### Q1：[基础] 文件系统的功能是什么？

A:
1. 分配磁盘空间：管理文件块（位置和顺序）；管理空闲空间(位置)；分配算法 (策略)。
2. 管理文件集合：定位：文件及其内容；命名：通过名字找到文件；文件系统结构：文件组织方式。
3. 数据可靠和安全：多层次保护数据安全；持久保存文件，避免系统崩溃、媒体错误、攻击等。

简单的说，磁盘驱动（如 ucore 的 ide.c）把磁盘抽象成一个数组 byte disk[NSECS][SECSZ]。这个接口还是不太方便，毕竟我们认为信息是被分好类的一个一个 “档案” 的形式存在的。（台湾省就把 file 译为檔案）
所以文件系统在磁盘驱动的基础上，建立了一个树状结构。通过这个树状结构，我们能够用 /home/xiaoming/classes/OS/homework 的形式索引磁盘上的档案。并且文件系统在此基础上增加一些特性，例如避免崩溃丢失信息、加密存储等。

#### Q2：[基础] 软链接和硬链接是干什么的？有什么区别？当删除一个软链接或硬链接时分别会发生什么？

A:
文件别名，磁盘上只存一份文件内容，但可以有多个文件关联它。
软链接：一类特殊的文件，文件内容是指向文件的路径。
硬链接：文件目录项指向同一个文件控制块，各个硬链接都是相同的。
删除软链接：只删除软链接文件，对原文件毫无影响。
删除硬链接：减少引用计数，当计数为 0 时删除文件控制块。

硬链接相对与软链接来说，不能跨文件系统，不能指向目录，不能指向一个不存在的文件。
我们无法区分硬链接和普通文件，但是可以区分软连接和普通文件。

#### Q3：[基础] 目录是一类特殊的文件，存放的是什么内容？用户可以自己修改目录内容吗？

A:
一个<文件名，文件在磁盘的位置>(目录项)的列表。
不可以，为确保映射的完整性，只能由OS修改目录内容，用户程序通过系统调用进行目录操作。

#### Q4：[基础] 为什么会存在大量的文件系统类型？

A:
数据类型：16位、32位、64位、128位文件系统
存储介质类型：磁盘、光盘等
访问安全要求类型：单用户文件系统、多用户文件系统
数据可靠性要求类型：日志文件系统
应用场景类型：网络、本地

#### Q5：[基础] 引入虚拟文件系统有什么好处？

A:
对上接口：统一上层应用的文件访问和控制接口
对下接口：实现对多种类型文件的访问和控制交互；
高效访问实现：打开文件信息的管理、高效的路径遍历实现

#### Q6：[基础] 文件卷控制块、文件控制块、目录项各是什么东西？

A:
文件卷控制块(superblock)：文件系统描述信息，如数据块大小、存储格式、空余块数目等；每个文件卷对应一个；挂载时读入内存；
文件控制块(inode)：文件的描述信息，如文件数据的存储位置和顺序等；每个文件对应一个；打开文件时读入内存；
目录项：每个目录由若干目录项组成，所有目录项共同形成文件系统的树状结构；每个目录项对应一个文件或目录；路径遍历时读入内存；

#### Q7：[基础] 可以把文件控制块放到目录项中吗？这样做有什么优缺点？

A:
可以。
优点：实现简单；
缺点：路径遍历时会读入目录项的内容，这样做使得搜索时数据读入量比较大。

并且，这样做以后硬链接会比较麻烦。

#### Q8：[基础] 为什么要同时维护进程的打开文件表和操作系统的打开文件表？这两个打开文件表有什么区别和联系？为什么没有线程的打开文件表？

A:
系统打开文件表：目录项和文件控制块信息的缓存、引用计数等
进程打开文件表：进程的打开文件的状态信息，如文件指针、文件访问权限等
联系：针对打开文件在内存中维护的数据缓存和文件状态信息
区别：进程打开文件表维护本进程特有的打开文件状态信息，系统打开文件表维护所有进程共用的打开文件信息；
相同进程中的各线程共享进程的打开文件信息，并没有需求针对线程维护打开文件状态信息；

#### Q9：[基础] 文件分配的三种方式是如何组织文件数据块的？各有什么特征（存储、文件读写、可靠性）？

A:
连续分配：文件数据块的存储是连续的；特征：存储位置必须在大于所需空间的空闲空间；读取性能比较好，文件增长开销比较大；
链式分配：用数据块的链表来存储文件数据块；特征：文件修改比较方便，随机文件读取开销大，可靠性比较差；
索引分配：用索引数据块来保存文件数据块的存储位置和顺序；特征：小文件存储开销大；文件读写性能较好；

#### Q10：[基础] 文件系统中，能出现环吗？

A:
不能。
如果有环，统计一个目录内所有文件的大小怎么办？
如果有环，rm -rf 一个目录怎么办？
允许文件系统有环，只会带来麻烦，没有什么收效。

其实，只有使用 链接 才可能使得文件系统出现环，使用文件系统的其他接口不会造成文件系统中出现环。

但是可能通过创建了软链接，使得文件系统中出现了 “环”。
一条命令即可：ln -s .. parent。但这不是一个真正的环。
（画图即可解释，注意软连接是一个文件，其中包含一个不一定有效的路径）

不能通过硬链接让文件系统出现环。
事实上，之所以硬链接不能指向目录，就是为了避免出现环。

#### Q11：[基础] 如果一个程序打开了一个文件，写入了一些数据，但是没有及时关闭，可能会有什么后果？

A:
1. 数据写在缓存中，还未写入磁盘，程序崩溃了数据可能会丢失，而且别的程序打开同一个文件可能看不到修改。
2. 占用资源，一个进程可同时打开的文件数是有限的(Linux 默认 1024)。
3. 占用文件锁，其他进程无法删除或写该文件(如Windows，但类Unix系统一般默认不加锁）

#### Q12：[进阶] 文件系统是一个操作系统必要的组件吗？是否可以将文件系统放到用户态？这样做有什么好处？OS需要提供哪些基本支持？

A:
不是，如微内核系统。
可以。
在用户态开发容易，错误不会影响内核，减小内核的大小(微内核的各种好处)。
在用户态访问磁盘地址空间的能力，如通过内存映射将磁盘地址空间映射到用户地址空间。

### 文件系统实例

#### Q1：[基础] FAT 文件系统设计中，用于记录可用块的使用链的文件分配表 (File Allocation Table) 及其备份被放在文件卷的开头，这样做会有什么问题？

A:
所有文件的读写、删除、创建都需要访问磁盘上的这块区域，导致这块区域极易损坏，造成整个文件系统不可用。当然可以通过 caching 来缓解，但是这块使用率肯定还是高于其他块。RAID 4 也有类似的问题。

#### Q2：[基础] FAT 文件系统设计中，是如何将 8.3 文件名格式拓展为长文件名的？

A:
通过 folder entry 中的 attribute byte，0x20 表示缩略名，0x0f 表示完整名字的一部分。

#### Q3：[基础] Ext4 文件系统中，为了支持大文件存储，在文件分配时引入了一段连续存储块 extent 的设计。相比多级索引块的设计，它有何优缺点？为何其缺点并不致命？

A:
优点：减少 ext2/3 中的 indirect block。可以找到指定的 data block 在磁盘中的位置所需的磁盘 I/O 次数更少，效率更高；可以减少 indirect block 浪费的空间。
缺点：类比内存管理的段机制，会产生内/外碎片；但是由于在文件系统的应用场景下，并不会频繁对于磁盘空间进行分配/回收，因此磁盘空间不足不会对系统使用产生致命影响，只需定期考虑磁盘碎片整理即可。

#### Q4：[概念] 如何理解事务的原子性以及文件系统的一致性？

A:
事务的原子性：指一次操作（如文件系统中创建一个文件，或数据库中一次增删改查），只有完全不做和全部完成两种可能，而不存在中间状态。
文件系统的：这里指的是磁盘上的字节序列能够描述一个合法的文件系统，满足文件系统的各种限制(可以通过 fsck)，且可以从初始状态经过若干次合法操作得到。

#### Q5：[基础] 在 Data Journaling 中，如果某次操作要修改 a,b,c 三个块，如果一步直接把 TxB,a,b,c,TxE 全部写入日志，而不是分成两步——先写入 TxB,a,b,c ，再写入 TxE，在什么情况下会出现问题？分成两步开销较大，有没有更简单的方法解决这个问题？

A:
背景：假定我们可以将多个块 I/O 操作分成一组同时提交给磁盘，磁盘保证如果能够正常返回(处理过程系统不崩溃)，那么这些操作都会完成；反之每个操作都有可能完成和失败。
如果将 TxB,a,b,c,TxE 的写入同时提交给磁盘，且磁盘在完成了 TxB 和 TxE 的写入的情况下，系统崩溃没有正常返回。那么重启系统的时候，会认为日志已经完成，需要 replay 操作。然而我们知道 a,b,c 中至少有一个没有完成，这明显是一个错误的日志，按照它去 replay 势必导致系统失去一致性。
比如加上所有块的 checksum 写入日志，在 replay 的时候先看 checksum 是否正确，如果不正确说明在写入日志的时候系统崩溃，直接把这个操作扔掉。

#### Q6：[基础] 将多个块 I/O 操作分成一组提交给磁盘，相比单独提交给磁盘，有何优点？

A:
1. 对于同一个块的写入操作可以进行合并，减少 I/O 次数；
2. 可以通过排序将随机访问转化为顺序访问，提高磁盘性能

#### Q7：如果日志的写入和 checkpoint 都并不是立即写入磁盘，而是先写入内存中的块缓存，然后定期写回磁盘，有什么优缺点？

A:
优点：降低了延迟，提高了吞吐量，充分利用磁盘性能
缺点：一旦出错，不能恢复到最新的版本，而只能回到近期的版本

#### Q8：[拓展] 在 ZFS 的 Copy-on-Write 机制中，应何时将版本过于落后的块回收以便后续使用？

A:
一种可能的思路是，在进行 COW 的时候，如果发现引用被复制的块的最新版本与当前版本相差超过一个阈值，则将被复制的块回收。